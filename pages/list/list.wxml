<!-- pages/list/list.wxml -->
<view class="container page-content">
  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <view class="filter-title">
      <text>{{pageTitle}}</text>
      <text class="book-total">{{total}}æœ¬</text>
    </view>
    <view class="filter-btn" bindtap="showFilterPanel">
      <view class="filter-icon">âš™ï¸</view>
      <text>ç­›é€‰</text>
    </view>
  </view>

  <!-- ç­›é€‰æ ‡ç­¾ -->
  <view wx:if="{{filterTags.length > 0}}" class="filter-tags">
    <block wx:for="{{filterTags}}" wx:key="index">
      <view class="filter-tag">
        <text>{{item.label}}: {{item.value}}</text>
        <view class="tag-close" bindtap="removeFilter" data-index="{{index}}">Ã—</view>
      </view>
    </block>
    <view class="clear-all" bindtap="clearAllFilters">æ¸…ç©º</view>
  </view>

  <!-- ä¹¦ç±åˆ—è¡¨ -->
  <scroll-view
    class="book-list"
    scroll-y
    bindscrolltolower="loadMore"
    lower-threshold="100"
    enable-back-to-top
  >
    <block wx:for="{{books}}" wx:key="_id">
      <view class="book-item" bindtap="goToDetail" data-id="{{item._id}}">
        <view class="book-cover">
          <image src="{{item.cover || '/images/default-cover.png'}}" mode="aspectFill"></image>
        </view>
        <view class="book-info">
          <view class="book-header">
            <text class="book-title">{{item.title}}</text>
            <view class="book-status">
              <text wx:if="{{item.purchased}}" class="status-icon purchased">âœ“</text>
              <text wx:if="{{item.read}}" class="status-icon read">ğŸ‘</text>
              <text wx:if="{{item.intensiveRead}}" class="status-icon intensive">â­</text>
            </view>
          </view>
          <text class="book-author">{{item.author}}</text>
          <text class="book-type">{{item.type}}</text>
          <text class="book-grade">{{item.gradeLevel}}</text>
          <text class="book-desc">{{item.description ? item.description.slice(0, 40) + '...' : 'æš‚æ— ç®€ä»‹'}}</text>
        </view>
      </view>
    </block>

    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view wx:if="{{loading}}" class="loading">
      <view class="loading-icon">â³</view>
      <text>åŠ è½½ä¸­...</text>
    </view>
    <view wx:if="{{!hasMore && books.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šä¹¦ç±äº†</text>
    </view>
    <view wx:if="{{books.length === 0 && !loading}}" class="empty">
      <view class="empty-icon">ğŸ“š</view>
      <text class="empty-text">æš‚æ— ä¹¦ç±</text>
      <text class="empty-desc">å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æ·»åŠ ä¹¦ç±</text>
    </view>
  </scroll-view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view wx:if="{{showFilterPanel}}" class="filter-panel-mask" bindtap="hideFilterPanel">
    <view class="filter-panel" catchtap="stopPropagation">
      <view class="filter-header">
        <text>ç­›é€‰æ¡ä»¶</text>
        <view class="filter-close" bindtap="hideFilterPanel">Ã—</view>
      </view>

      <scroll-view class="filter-content" scroll-y>
        <!-- å¹´çº§ç­›é€‰ -->
        <view class="filter-section">
          <text class="section-title">é€‚åˆå¹´çº§</text>
          <view class="filter-options">
            <view
              class="filter-option {{filters.gradeLevel === 'ä¸€è‡³äºŒå¹´çº§' ? 'active' : ''}}"
              bindtap="setGradeFilter"
              data-value="ä¸€è‡³äºŒå¹´çº§"
            >
              <text>ä¸€è‡³äºŒå¹´çº§</text>
              <view wx:if="{{filters.gradeLevel === 'ä¸€è‡³äºŒå¹´çº§'}}" class="option-check">âœ“</view>
            </view>
            <view
              class="filter-option {{filters.gradeLevel === 'ä¸‰è‡³å››å¹´çº§' ? 'active' : ''}}"
              bindtap="setGradeFilter"
              data-value="ä¸‰è‡³å››å¹´çº§"
            >
              <text>ä¸‰è‡³å››å¹´çº§</text>
              <view wx:if="{{filters.gradeLevel === 'ä¸‰è‡³å››å¹´çº§'}}" class="option-check">âœ“</view>
            </view>
            <view
              class="filter-option {{filters.gradeLevel === 'äº”è‡³å…­å¹´çº§' ? 'active' : ''}}"
              bindtap="setGradeFilter"
              data-value="äº”è‡³å…­å¹´çº§"
            >
              <text>äº”è‡³å…­å¹´çº§</text>
              <view wx:if="{{filters.gradeLevel === 'äº”è‡³å…­å¹´çº§'}}" class="option-check">âœ“</view>
            </view>
          </view>
        </view>

        <!-- çŠ¶æ€ç­›é€‰ -->
        <view class="filter-section">
          <text class="section-title">é˜…è¯»çŠ¶æ€</text>
          <view class="filter-switches">
            <view class="filter-switch">
              <text>å·²è´­ä¹°</text>
              <switch checked="{{filters.purchased}}" bindchange="togglePurchased" color="#52C41A" />
            </view>
            <view class="filter-switch">
              <text>å·²é˜…è¯»</text>
              <switch checked="{{filters.read}}" bindchange="toggleRead" color="#1890FF" />
            </view>
            <view class="filter-switch">
              <text>å·²ç²¾è¯»</text>
              <switch checked="{{filters.intensiveRead}}" bindchange="toggleIntensive" color="#FAAD14" />
            </view>
          </view>
        </view>

        <!-- æ’åºæ–¹å¼ -->
        <view class="filter-section">
          <text class="section-title">æ’åºæ–¹å¼</text>
          <view class="filter-options">
            <view
              class="filter-option {{sortField === 'serial' ? 'active' : ''}}"
              bindtap="setSortField"
              data-field="serial"
            >
              <text>æŒ‰åºå·</text>
              <view wx:if="{{sortField === 'serial'}}" class="option-check">âœ“</view>
            </view>
            <view
              class="filter-option {{sortField === 'title' ? 'active' : ''}}"
              bindtap="setSortField"
              data-field="title"
            >
              <text>æŒ‰ä¹¦å</text>
              <view wx:if="{{sortField === 'title'}}" class="option-check">âœ“</view>
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="filter-actions">
        <view class="filter-btn reset" bindtap="resetFilters">é‡ç½®</view>
        <view class="filter-btn apply" bindtap="applyFilters">åº”ç”¨ç­›é€‰</view>
      </view>
    </view>
  </view>
</view>